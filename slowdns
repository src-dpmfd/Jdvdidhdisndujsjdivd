#!/bin/bash
# Script unificado por Gemini - Mantendo a lógica original

#================================================================
# PARTE 1: FUNÇÕES DO INSTALADOR ORIGINAL
# Estas são as funções que o seu script de instalação usava.
# Elas foram trazidas para cá sem alterações na lógica.
#================================================================

fun_bar () {
    comando[0]="$1"
    comando[1]="$2"
    (
    [[ -e $HOME/fim ]] && rm $HOME/fim
    ${comando[0]} -y > /dev/null 2>&1
    ${comando[1]} -y > /dev/null 2>&1
    touch $HOME/fim
    ) > /dev/null 2>&1 &
    tput civis
    echo -ne "  \033[1;33mAGUARDE \033[1;37m- \033[1;33m["
    while true; do
       for((i=0; i<18; i++)); do
       echo -ne "\033[1;31m#"
       sleep 0.1s
       done
       [[ -e $HOME/fim ]] && rm $HOME/fim && break
       echo -e "\033[1;33m]"
       sleep 1s
       tput cuu1
       tput dl1
       echo -ne "  \033[1;33mAGUARDE \033[1;37m- \033[1;33m["
    done
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m OK !\033[1;37m"
    tput cnorm
}

fun_att () {
    apt install ncurses-utils -y
    mkdir -p /etc/slowdns
    cd /etc/slowdns
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/dns-server; chmod +x dns-server
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/remove-slow; chmod +x remove-slow
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/slowdns-info; chmod +x slowdns-info
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/slowdns-drop; chmod +x slowdns-drop
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/slowdns-ssh; chmod +x slowdns-ssh
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/slowdns-ssl; chmod +x slowdns-ssl
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/slowdns-socks; chmod +x slowdns-socks
    wget -q https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/stopdns; chmod +x stopdns
}

fun_ports () {
    apt install firewalld -y && sudo firewall-cmd --zone=public --permanent --add-port=80/tcp && sudo firewall-cmd --zone=public --permanent --add-port=8080/tcp && sudo firewall-cmd --zone=public --permanent --add-port=443/tcp && sudo firewall-cmd && sudo firewall-cmd --zone=public --permanent --add-port=53/udp && sudo firewall-cmd --zone=public --permanent --add-port=5300/udp && sudo firewall-cmd && sudo firewall-cmd --zone=public --permanent --add-port=2222/tcp && sudo firewall-cmd --reload
}

fun_dnscf () {
    sudo systemctl disable systemd-resolved.service && sudo systemctl stop systemd-resolved.service && sudo mv /etc/resolv.conf /etc/resolv.conf.bkp && echo "nameserver 1.1.1.1" > /etc/resolv.conf
    sudo systemctl enable systemd-resolved.service && sudo systemctl start systemd-resolved.service
    sleep 2
}

# NOVA FUNÇÃO: encapsula todo o processo de instalação.
# Esta função será chamada pela nova opção do menu.
instalar_slowdns() {
    clear
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    tput setaf 7 ; tput setab 4 ; tput bold ; printf '%40s%s%-12s\n' "INSTALADOR SLOWDNS MANAGER" ; tput sgr0
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    echo ""
    echo -e "      Esse script irá (re)instalar todos os"
    echo -e "   componentes do gerenciador de conexão SlowDNS."
    echo ""
    echo -e "         \033[1;33mInstalador feito por edição \033[1;37m"
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    echo ""
    echo -e "BAIXANDO DEPENDENCIAS..."
    echo ""
    fun_bar 'fun_att'
    echo -e "CONFIGURANDO FIREWALL..."
    echo ""
    fun_bar 'fun_ports'
    echo -e "DEFININDO DNS DO CLOUDFLARE..."
    echo ""
    fun_bar 'fun_dnscf'
    clear
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    tput setaf 7 ; tput setab 4 ; tput bold ; printf '%40s%s%-12s\n' "INSTALADOR SLOWDNS MANAGER" ; tput sgr0
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    echo ""
    echo -e "          \033[1;33mINSTALAÇÃO CONCLUIDA!\033[0m          "
    echo ""
    read -p "Pressione [ENTER] para voltar ao menu..."
}


#================================================================
# PARTE 2: FUNÇÕES DO MENU ORIGINAL
# A lógica do seu menu e das opções foi mantida.
#================================================================

Opcao1 () { clear; bash /etc/slowdns/slowdns-ssh; }
Opcao2 () { clear; bash /etc/slowdns/slowdns-ssl; }
Opcao3 () { clear; bash /etc/slowdns/slowdns-drop; }
Opcao4 () { clear; bash /etc/slowdns/slowdns-socks; }
Opcao5 () { clear; bash /etc/slowdns/slowdns-info; }
Opcao6 () { clear; bash /etc/slowdns/startdns; }
Opcao7 () { clear; bash /etc/slowdns/restartdns; }
Opcao8 () { clear; bash /etc/slowdns/stopdns; }
Opcao9 () { clear; bash /etc/slowdns/stopdns; bash /etc/slowdns/remove-slow; }
Opcao11 () {
    clear
    bash /etc/slowdns/remove-slow
    echo -e "\033[0;31mSlowDNS Manager Desinstalado!\033[0m"
    sleep 2
    rm /bin/slowdns
}
Sair() { clear; exit; }

# FUNÇÃO PRINCIPAL: O MENU
slowdns () {
    clear
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    tput setaf 7 ; tput setab 4 ; tput bold ; printf '%40s%s%-12s\n' "MENU SLOWDNS MANAGER V4.0" ; tput sgr0
    echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
    echo -e "\033[0;36m#===================================================#\033[m"
    echo -e "\033[0;36m# .|'''.|'||                '||''|. '|.   '|'.|'''.|#\033[m"
    echo -e "\033[0;36m# ||..  ' ||  ... ... ... ...||   || |'|   | ||..  '#\033[m"
    echo -e "\033[0;36m#  ''|||. ||.|  '|.||  ||  | ||    ||| '|. |  ''|||.#\033[m"
    echo -e "\033[0;36m#.     '||||||   || ||| |||  ||    |||   |||.     '|#\033[m"
    echo -e "\033[0;36m#|'....|'.||.'|..|'  |   |  .||...|'.|.   '||'....|'#\033[m"
    echo -e "\033[0;36m#---------------------------------------------------#\033[m"
    echo -e "\033[0;36m#\033[m \033[0;31mSlowDNS | Desfrute e passe tempo\033[m \033[0;36m#\033[m"
    echo -e "\033[0;36m#===================================================#\033[m"
    echo ""
    echo -e "\033[0;36m[01]\033[m | Instalar SlowDNS SSH"
    echo -e "\033[0;36m[02]\033[m | Instalar SlowDNS SSL"
    echo -e "\033[0;36m[03]\033[m | Instalar SlowDNS DROP"
    echo -e "\033[0;36m[04]\033[m | Instalar SlowDNS SOCKS"
    echo -e "\033[0;36m[05]\033[m | Ver informações"
    echo -e "\033[0;36m[06]\033[m | Iniciar SlowDNS"
    echo -e "\033[0;36m[07]\033[m | Reiniciar SlowDNS"
    echo -e "\033[0;36m[08]\033[m | Parar SlowDNS"
    echo -e "\033[0;36m[09]\033[m | Remover SlowDNS"
    # --- MUDANÇA PRINCIPAL AQUI ---
    echo -e "\033[0;36m[10]\033[m | \033[1;31m(Re)Instalar Gerenciador\033[0m"
    echo -e "\033[0;36m[11]\033[m | Remover Script"
    echo -e "\033[0;36m[00]\033[m | SAIR"
    echo ""
    echo -ne "\033[0;36mO que deseja fazer?:\033[m " && read opcao
    case $opcao in
        1) Opcao1 ;;
        2) Opcao2 ;;
        3) Opcao3 ;;
        4) Opcao4 ;;
        5) Opcao5 ;;
        6) Opcao6 ;;
        7) Opcao7 ;;
        8) Opcao8 ;;
        9) Opcao9 ;;
        # --- MUDANÇA PRINCIPAL AQUI ---
        10) instalar_slowdns ;; # Agora chama a nossa nova função de instalação
        11) Opcao11 ;;
        0) Sair ;;
        *) echo "Opção inválida" ; sleep 1 ; slowdns ;;
    esac
    # Adicionado para que o menu sempre reapareça após uma ação
    slowdns
}

#================================================================
# PARTE 3: INÍCIO DO SCRIPT
# A única coisa que o script faz ao ser executado é chamar o menu.
#================================================================
slowdns
#!/bin/bash
#################
# molezinha üòè      #
# By: @alfalemos    #
#################
check_and_install_packages() {
    PACKAGES_TO_INSTALL=()
    if ! command -v unzip &> /dev/null; then
        PACKAGES_TO_INSTALL+=("unzip")
    fi
    if ! command -v screen &> /dev/null; then
        PACKAGES_TO_INSTALL+=("screen")
    fi

    if [ ${#PACKAGES_TO_INSTALL[@]} -ne 0 ]; then
        echo -e "\033[1;33mInstalando depend√™ncias necess√°rias..."
        if command -v apt-get &> /dev/null; then
            apt-get update &>/dev/null
            apt-get install -y ${PACKAGES_TO_INSTALL[@]} &>/dev/null
        elif command -v yum &> /dev/null; then
            yum install -y ${PACKAGES_TO_INSTALL[@]} &>/dev/null
        fi
        echo -e "\033[1;32mDepend√™ncias instaladas.\033[0m"
        sleep 1
    fi
}

install_websocket() {
    clear
    echo -e "\033[1;33mVerificando instala√ß√£o do WebSocket...\033[0m"
    sleep 1
    
    echo -e "\033[1;33mBaixando...\033[0m"
    
    wget -q -O /usr/bin/wssecury.sh.1 https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/wssecury.sh.1
    
    chmod +x /usr/bin/wssecury.sh.1
    
    screen -dmS wssecury /usr/bin/wssecury.sh.1 && wsmenu
    echo -e "\033[1;32mBaixando....\033[0m"
    sleep 1
    
    if [ -f "/etc/SSHPlus/WebSocket" ]; then
        echo -e "\033[1;32mO WebSocket j√° est√° instalado. Verificando atualiza√ß√µes...\033[0m"
    else
        echo -e "\033[1;33mIniciando a instala√ß√£o do WebSocket...\033[0m"
    fi

    mkdir -p /etc/SSHPlus
    cd /etc/SSHPlus || exit
    
    wget -q --no-check-certificate https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/WebSocket.zip && \
    unzip -oq WebSocket.zip && \
    rm WebSocket.zip && \
    chmod +x WebSocket
    
    if [ $? -eq 0 ]; then
        echo -e "\033[1;32mInstala√ß√£o/Atualiza√ß√£o do WebSocket conclu√≠da com sucesso!\033[0m"
    else
        echo -e "\033[1;31mOcorreu um erro durante a instala√ß√£o do WebSocket.\033[0m"
        rm -f WebSocket.zip WebSocket &>/dev/null
    fi
}
stop_service() {
    clear
    echo -e "\033[1;33mParando o servi√ßo WebSocket...\033[0m"
    pkill -f "/etc/SSHPlus/WebSocket"
    screen -S ws -X quit &>/dev/null
    sleep 1
    echo -e "\033[1;32mServi√ßo parado com sucesso!\033[0m"
}
uninstall_websocket() {
    clear
    echo -e "\E[41;1;37m        DESINSTALAR WEBSOCKET        \E[0m\n"
    read -p " Voc√™ tem certeza que deseja remover o WebSocket? [s/N]: " CONFIRM
    
    if [[ "$CONFIRM" =~ ^[sS]$ ]]; then
        echo -e "\n\033[1;33mParando qualquer servi√ßo ativo...\033[0m"
        pkill -f "/etc/SSHPlus/WebSocket"
        screen -S ws -X quit &>/dev/null
        screen -S wssecury -X quit &>/dev/null
        sleep 1
        
        echo -e "\033[1;33mRemovendo arquivos...\033[0m"
        rm -f /etc/SSHPlus/WebSocket
        rm -f /usr/bin/wssecury.sh.1
        
        if [ -d "/etc/SSHPlus" ] && [ -z "$(ls -A /etc/SSHPlus)" ]; then
            echo -e "\033[1;33mRemovendo diret√≥rio de configura√ß√£o vazio...\033[0m"
            rm -rf /etc/SSHPlus
        fi
        
        sleep 1
        echo -e "\n\033[1;32mWebSocket desinstalado com sucesso!\033[0m"
    else
        echo -e "\n\033[1;31mDesinstala√ß√£o cancelada.\033[0m"
    fi
}
configure_and_start() {
    clear
    echo -e "\E[44;1;37m      WEBSOCKET SECURITY  by:@alfalemos      \E[0m\n"
    
    read -p " Digite a porta para o WebSocket (padr√£o: 80): " WS_PORT
    WS_PORT=${WS_PORT:-80}
    echo ""
    echo -e " Escolha o modo de opera√ß√£o:"
    echo -e " \033[1;33m1)\033[0m Proxy Websocket"
    echo -e " \033[1;33m2)\033[0m Proxy Websocket TLS (SSL)"
    read -p " Op√ß√£o [1-2] (padr√£o: 1): " -e -i 1 MODE_CHOICE
    echo ""
    read -p " Digite a mensagem de resposta (padr√£o: websocket-@alfalemos): " RESPONSE_MSG
    RESPONSE_MSG=${RESPONSE_MSG:-websocket-@alfalemos}

    pkill -f "/etc/SSHPlus/WebSocket"
    screen -S ws -X quit &>/dev/null
    sleep 1

    CMD="/etc/SSHPlus/WebSocket -proxy_port 0.0.0.0:${WS_PORT} -msg=${RESPONSE_MSG}"
    if [ "$MODE_CHOICE" = "2" ]; then
        CMD="$CMD -tls=true"
    fi

    screen -dmS ws ${CMD}

    sleep 2
    if screen -list | grep -q "ws"; then
        echo -e "\n\033[1;32mServi√ßo WebSocket iniciado com sucesso!\033[0m"
    else
        echo -e "\n\033[1;31mErro ao iniciar o servi√ßo WebSocket.\033[0m"
    fi
}
main_menu() {
    while true; do
        clear
        echo -e "\E[44;1;37m      WEBSOCKET SECURITY  by:@alfalemos bin     \E[0m"
        echo ""

        PROCESS_CMD=$(ps aux | grep '/etc/SSHPlus/WebSocket' | grep -v grep)
        if [ -n "$PROCESS_CMD" ]; then
            PORT=$(echo "$PROCESS_CMD" | grep -oP 'proxy_port \S+:\K[0-9]+')
            if echo "$PROCESS_CMD" | grep -q -- '-tls=true'; then
                MODE="TLS/SSL P-WS"
            else
                MODE="PROXY WS"
            fi
            printf " Status: \033[1;32m%-10s\033[0m Porta: \033[1;33m%-9s\033[0m Modo: \033[1;33m%s\033[0m\n" "ATIVO" "$PORT" "$MODE"
        else
            printf " Status: \033[1;31m%s\033[0m\n" "INATIVO"
        fi

        echo ""
        echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;37m‚Ä¢ \033[1;33mINICIAR / ALTERAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;37m‚Ä¢ \033[1;33mPARAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m3\033[1;31m] \033[1;37m‚Ä¢ \033[1;33mINSTALAR / ATUALIZAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m4\033[1;31m] \033[1;37m‚Ä¢ \033[1;31mDESINSTALAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m0\033[1;31m] \033[1;37m‚Ä¢ \033[1;33mVOLTAR \033[0m"
        echo ""
        read -p " --> Selecione uma op√ß√£o: " option

        case $option in
            1)
                if [ ! -f "/etc/SSHPlus/WebSocket" ]; then
                    echo -e "\n\033[1;31mWebSocket n√£o instalado. Use a op√ß√£o 3.\033[0m"; sleep 2
                else
                    configure_and_start; read -p $'\n Pressione [Enter] para continuar...'
                fi;;
            2)
                stop_service; read -p $'\n Pressione [Enter] para continuar...';;
            3)
                install_websocket; read -p $'\n Pressione [Enter] para continuar...';;
            4)
                uninstall_websocket; read -p $'\n Pressione [Enter] para continuar...';;
            0)
                clear; conexao;;
            *)
                echo -e "\n\033[1;31mOp√ß√£o inv√°lida!\033[0m"; sleep 1;;
        esac
    done
}
check_and_install_packages
main_menu
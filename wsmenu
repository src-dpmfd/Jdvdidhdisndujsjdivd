#!/bin/bash

#================================================================================#
# SCRIPT DE GERENCIAMENTO DO WEBSOCKET
#================================================================================#
check_and_install_packages() {
    PACKAGES_TO_INSTALL=()
    if ! command -v unzip &> /dev/null; then
        PACKAGES_TO_INSTALL+=("unzip")
    fi
    if ! command -v screen &> /dev/null; then
        PACKAGES_TO_INSTALL+=("screen")
    fi

    if [ ${#PACKAGES_TO_INSTALL[@]} -ne 0 ]; then
        echo -e "\033[1;33mInstalando dependências necessárias..."
        if command -v apt-get &> /dev/null; then
            apt-get update &>/dev/null
            apt-get install -y ${PACKAGES_TO_INSTALL[@]} &>/dev/null
        elif command -v yum &> /dev/null; then
            yum install -y ${PACKAGES_TO_INSTALL[@]} &>/dev/null
        fi
        echo -e "\033[1;32mDependências instaladas.\033[0m"
        sleep 1
    fi
}

# VERSÃO CORRIGIDA DA FUNÇÃO install_websocket
install_websocket() {
    clear
    echo -e "\033[1;33mIniciando a Instalação/Atualização do WebSocket...\033[0m"
    sleep 1

    if [ -f "/etc/SSHPlus/WebSocket" ]; then
        echo -e "\033[1;32mO WebSocket já está instalado. Prosseguindo com a atualização...\033[0m"
    else
        echo -e "\033[1;33mIniciando a primeira instalação do WebSocket...\033[0m"
    fi
    sleep 1

    echo -e "\033[1;33mCriando diretório de configuração...\033[0m"
    mkdir -p /etc/SSHPlus
    cd /etc/SSHPlus || exit

    echo -e "\033[1;33mBaixando o pacote WebSocket...\033[0m"
    # Bloco único para baixar, extrair e dar permissão, garantindo um melhor controle de erro
    if wget -q --no-check-certificate https://raw.githubusercontent.com/src-dpmfd/Jdvdidhdisndujsjdivd/main/WebSocket.zip && \
       unzip -oq WebSocket.zip && \
       rm WebSocket.zip && \
       chmod +x WebSocket; then

        echo -e "\033[1;32mInstalação/Atualização do WebSocket concluída com sucesso!\033[0m"
        echo -e "\033[1;33mIniciando configuração do serviço...\033[0m"
        sleep 2
        # Chama a função para configurar e iniciar o serviço automaticamente após instalar
        configure_and_start
    else
        echo -e "\033[1;31mOcorreu um erro durante a instalação do WebSocket.\033[0m"
        # Limpa arquivos em caso de falha
        rm -f WebSocket.zip WebSocket &>/dev/null
    fi
}

stop_service() {
    clear
    echo -e "\033[1;33mParando o serviço WebSocket...\033[0m"
    pkill -f "/etc/SSHPlus/WebSocket"
    screen -S ws -X quit &>/dev/null
    sleep 1
    echo -e "\033[1;32mServiço parado com sucesso!\033[0m"
}

uninstall_websocket() {
    clear
    echo -e "\E[41;1;37m        DESINSTALAR WEBSOCKET        \E[0m\n"
    read -p " Você tem certeza que deseja remover o WebSocket? [s/N]: " CONFIRM
    
    if [[ "$CONFIRM" =~ ^[sS]$ ]]; then
        echo -e "\n\033[1;33mParando qualquer serviço ativo...\033[0m"
        pkill -f "/etc/SSHPlus/WebSocket"
        screen -S ws -X quit &>/dev/null
        screen -S wssecury -X quit &>/dev/null
        sleep 1
        
        echo -e "\033[1;33mRemovendo arquivos...\033[0m"
        rm -f /etc/SSHPlus/WebSocket
        rm -f /usr/bin/wssecury.sh.1
        
        if [ -d "/etc/SSHPlus" ] && [ -z "$(ls -A /etc/SSHPlus)" ]; then
            echo -e "\033[1;33mRemovendo diretório de configuração vazio...\033[0m"
            rm -rf /etc/SSHPlus
        fi
        
        sleep 1
        echo -e "\n\033[1;32mWebSocket desinstalado com sucesso!\033[0m"
    else
        echo -e "\n\033[1;31mDesinstalação cancelada.\033[0m"
    fi
}

configure_and_start() {
    clear
    echo -e "\E[44;1;37m      WEBSOCKET SECURITY  by:@alfalemos      \E[0m\n"
    
    read -p " Digite a porta para o WebSocket (padrão: 80): " WS_PORT
    WS_PORT=${WS_PORT:-80}
    echo ""
    echo -e " Escolha o modo de operação:"
    echo -e " \033[1;33m1)\033[0m Proxy Websocket"
    echo -e " \033[1;33m2)\033[0m Proxy Websocket TLS (SSL)"
    read -p " Opção [1-2] (padrão: 1): " -e -i 1 MODE_CHOICE
    echo ""
    read -p " Digite a mensagem de resposta (padrão: websocket-@alfalemos): " RESPONSE_MSG
    RESPONSE_MSG=${RESPONSE_MSG:-websocket-@alfalemos}

    pkill -f "/etc/SSHPlus/WebSocket"
    screen -S ws -X quit &>/dev/null
    sleep 1

    CMD="/etc/SSHPlus/WebSocket -proxy_port 0.0.0.0:${WS_PORT} -msg=${RESPONSE_MSG}"
    if [ "$MODE_CHOICE" = "2" ]; then
        CMD="$CMD -tls=true"
    fi

    screen -dmS ws ${CMD}

    sleep 2
    if screen -list | grep -q "ws"; then
        echo -e "\n\033[1;32mServiço WebSocket iniciado com sucesso!\033[0m"
    else
        echo -e "\n\033[1;31mErro ao iniciar o serviço WebSocket.\033[0m"
    fi
}

main_menu() {
    while true; do
        clear
        echo -e "\E[44;1;37m      WEBSOCKET SECURITY  by:@alfalemos      \E[0m"
        echo ""

        PROCESS_CMD=$(ps aux | grep '/etc/SSHPlus/WebSocket' | grep -v grep)
        if [ -n "$PROCESS_CMD" ]; then
            PORT=$(echo "$PROCESS_CMD" | grep -oP 'proxy_port \S+:\K[0-9]+')
            if echo "$PROCESS_CMD" | grep -q -- '-tls=true'; then
                MODE="TLS/SSL P-WS"
            else
                MODE="PROXY WS"
            fi
            printf " Status: \033[1;32m%-10s\033[0m Porta: \033[1;33m%-9s\033[0m Modo: \033[1;33m%s\033[0m\n" "ATIVO" "$PORT" "$MODE"
        else
            printf " Status: \033[1;31m%s\033[0m\n" "INATIVO"
        fi

        echo ""
        echo -e "\033[1;31m[\033[1;36m1\033[1;31m] \033[1;37m• \033[1;33mINICIAR / ALTERAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m2\033[1;31m] \033[1;37m• \033[1;33mPARAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m3\033[1;31m] \033[1;37m• \033[1;33mINSTALAR / ATUALIZAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m4\033[1;31m] \033[1;37m• \033[1;33mDESINSTALAR WEBSOCKET\033[0m"
        echo -e "\033[1;31m[\033[1;36m0\033[1;31m] \033[1;37m• \033[1;33mSAIR DO SCRIPT\033[0m"
        echo ""
        read -p " --> Selecione uma opção: " option

        case $option in
            1)
                if [ ! -f "/etc/SSHPlus/WebSocket" ]; then
                    echo -e "\n\033[1;31mWebSocket não instalado. Use a opção 3.\033[0m"; sleep 2
                else
                    configure_and_start; read -p $'\n Pressione [Enter] para continuar...'
                fi;;
            2)
                stop_service; read -p $'\n Pressione [Enter] para continuar...';;
            3)
                install_websocket; read -p $'\n Pressione [Enter] para continuar...';;
            4)
                uninstall_websocket; read -p $'\n Pressione [Enter] para continuar...';;
            0)
                clear; exit 0;; # Adicionada saída correta do script
            *)
                echo -e "\n\033[1;31mOpção inválida!\033[0m"; sleep 1;;
        esac
    done
}

# Execução do script
check_and_install_packages
main_menu
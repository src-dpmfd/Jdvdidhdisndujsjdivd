#!/bin/bash

# =================================================================
# Gerenciador do Stub Resolver (v10)
# Descrição: Verifica e gerencia o link simbólico do /etc/resolv.conf
#            para garantir que o sistema use o systemd-resolved.
# =================================================================

# --- Configuração de Cores ---
VERDE='\033[1;32m'
AMARELO='\033[1;33m'
VERMELHO='\033[1;31m'
BRANCO='\033[1;37m'
AZUL_FUNDO='\E[44;1;37m'
NORMAL='\033[0m'

# --- Funções ---

# 1. FUNÇÃO DE VERIFICAÇÃO DE STATUS
# Verifica se /etc/resolv.conf é um link simbólico para o stub-resolv.conf
verificar_status_stub() {
    local resolv_path="/etc/resolv.conf"
    local stub_path="/run/systemd/resolve/stub-resolv.conf"

    # Verifica se o arquivo é um link simbólico E se o destino está correto
    if [[ -L "$resolv_path" ]] && [[ "$(readlink "$resolv_path")" == "$stub_path" ]]; then
        echo -e "${VERDE}ATIVO${NORMAL} (O sistema está usando o resolvedor local)"
    else
        echo -e "${VERMELHO}INATIVO${NORMAL} (O sistema está usando um DNS estático)"
    fi
}

# 2. FUNÇÃO PARA ATIVAR O STUB RESOLVER
# Cria o link simbólico para que o sistema passe a usar o 127.0.0.53
ativar_stub_resolver() {
    clear
    echo -e "${AZUL_FUNDO}          ATIVANDO O RESOLVEDOR LOCAL (STUB)          \E[0m\n"
    
    # É crucial que o serviço systemd-resolved esteja rodando antes de fazer o link
    if ! systemctl is-active --quiet systemd-resolved; then
        echo "-> O serviço 'systemd-resolved' está parado. Iniciando..."
        systemctl start systemd-resolved
        sleep 1
    fi

    echo "-> Fazendo backup do arquivo /etc/resolv.conf atual para /etc/resolv.conf.bak..."
    # O comando 'mv -f' sobrescreve um backup antigo se houver
    mv -f /etc/resolv.conf /etc/resolv.conf.bak 2>/dev/null

    echo "-> Criando o link simbólico para usar o resolvedor local..."
    ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

    echo -e "\n${VERDE}ATIVADO COM SUCESSO!${NORMAL}"
    echo "O sistema agora está configurado para usar o 'nameserver 127.0.0.53'."
    echo "Isso centraliza todas as consultas de DNS através do systemd-resolved."
    
    read -p $'\n  Pressione Enter para voltar ao menu.'
}


# --- LOOP DO MENU PRINCIPAL ---
while true; do
    clear
    
    # O status é verificado toda vez que o menu é exibido
    STATUS_ATUAL=$(verificar_status_stub)
    
    echo -e "${AZUL_FUNDO}      GERENCIADOR DO RESOLVEDOR LOCAL (STUB)      \E[0m\n"
    echo -e "   Este script gerencia o arquivo '/etc/resolv.conf' para"
    echo -e "   determinar se o sistema usa o serviço de DNS local."
    echo -e "   (nameserver 127.0.0.53)\n"
    
    echo -e "   ${BRANCO}Status Atual: $STATUS_ATUAL${NORMAL}\n"
    
    # A opção de ativar só aparece se o status for INATIVO
    if [[ "$STATUS_ATUAL" == *INATIVO* ]]; then
        echo -e "  ${AMARELO}1) ATIVAR o resolvedor local (recomendado)${NORMAL}"
    fi
    
    echo "  0) Sair\n"
    
    read -p "  Escolha uma opção: " opcao
    
    case $opcao in
        1)
            if [[ "$STATUS_ATUAL" == *INATIVO* ]]; then
                ativar_stub_resolver
            else
                echo -e "\n${VERMELHO}Opção inválida.${NORMAL}"; sleep 1
            fi
            ;;
        0) clear; exit 0 ;;
        *) echo -e "\n${VERMELHO}Opção inválida.${NORMAL}"; sleep 1 ;;
    esac
done